
(function($){var methods={init:function(options){var defaults={button_width:45,column:0,position:'left',trigger:'mouseover',};var settings=$.extend(defaults,options);if($('#tablemenu_context_menu').length==0){$("body").append('<div id="tablemenu_context_menu"></div>');}
$('#tablemenu_context_menu').mouseleave(function(){$('#tablemenu_context_menu').hide();});return this.each(function(e){var obj=$(this);$(this).bind('update',function(){build_menu(settings,obj);});build_menu(settings,obj);});},stop:function(){},destroy:function(){}};function build_menu(settings,obj){var items=$("tbody > tr",obj);items.mouseleave(function(e){var to_element=e.relatedTarget;if(to_element!=null&&to_element.localName!="table"&&(e.relatedTarget.id!="tablemenu_context_menu"&&e.relatedTarget.parentNode.id!="tablemenu_context_menu")){$('#tablemenu_context_menu').hide();}});items.bind(settings.trigger,function(e){var menu_items=settings.menu_items;var control_width;var dk_data=eval('(['+$(this).attr('dk_data')+'])')[0];var dk_options=eval('(['+$(this).attr('dk_options')+'])')[0];if(settings.width!=null){control_width=settings.width;}else{control_width=Object.keys(dk_options).length*settings.button_width;}
if(dk_data.id!=null&&menu_items['edit']['url']!=null){$(this).bind('dblclick',function(){window.location.href=menu_items['edit']['url']+dk_data.id;});}
$('#tablemenu_context_menu').html('');$.each(menu_items,function(key,val){if(dk_options[key]!=null){var button=document.createElement('button');$(button).html('<i class="'+val.icon+'"></i>');if(val.title!=null){$(button).attr('title',val.title);}
if(dk_options[key]==0){$(button).attr('disabled','disabled');}
if(val.class_name!=null){$(button).addClass(val.class_name);}else{$(button).addClass("btn");}
var url="";if(val.url!=null){url+=val.url;}
if(dk_data.id!=null){url+=dk_data.id;}
$(button).attr('url',url);if(val.confirm!=null){var confirm_message=val.confirm;var placeholders=get_placeholders(confirm_message);$.each(placeholders,function(placeholder_key,placeholder_val){replacement=dk_data[placeholder_val];confirm_message=confirm_message.replace("$("+placeholder_val+")",replacement);});$(button).bind('touchstart click',function(){bootbox.confirm(confirm_message,function(confirmed){if(confirmed){window.location.href=url;}});});}else{$(button).bind('touchstart click',function(){window.location.href=$(this).attr('url');});}
$(button).attr('rel','tooltip');$("#tablemenu_context_menu").append(button);}});var bottomWidth=control_width+"px";var bottomHeight=$(this).height()-1+"px";var lineHeight=$(this).height()-3+"px";var row_position=$(this).position();var border_offset=0;if(!$.browser.webkit){border_offset=1;}
var num_of_child_elements=$(this).children().size();var append_column;var tablemenu_context_menu_position=0;if(settings.column>=num_of_child_elements){settings.column=num_of_child_elements-1;settings.position="after";}else if(settings.column<0){settings.column=0;settings.position="before";}
if(settings.position=="left"){append_column=$(this).children().eq(settings.column);tablemenu_context_menu_position=append_column.position().left;}else if(settings.position=="right"){append_column=$(this).children().eq(settings.column);tablemenu_context_menu_position=append_column.position().left+append_column.outerWidth()-1-control_width;}else if(settings.position=="after"){append_column=$(this).children().eq(num_of_child_elements-1);tablemenu_context_menu_position=append_column.position().left+append_column.outerWidth();}else if(settings.position=="before"){append_column=$(this).children().eq(settings.column);tablemenu_context_menu_position=append_column.position().left-1-control_width;}
var bottomTop=row_position.top-border_offset;var bottomLeft=tablemenu_context_menu_position-border_offset;$('#tablemenu_context_menu').css({top:bottomTop,left:bottomLeft,width:bottomWidth,height:bottomHeight,lineHeight:lineHeight,});$('#tablemenu_context_menu').addClass(settings.position);$("#tablemenu_context_menu [disabled!=disabled][rel=tooltip]").tooltip();$('#tablemenu_context_menu').show();});}
function get_placeholders(str){var regex=/\$\((\w+)\)/g;var result=[];while(match=regex.exec(str)){result.push(match[1]);}
return result;}
$.fn.tablemenu=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else{$.error('Method '+method+' does not exist in tablemenu plugin.');}};})(window.jQuery);